<?xml version='1.0'?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <?include ../fig.wxi?>

    <Product
        Id="*"
        Language='1033'
        Manufacturer="Fig"
        Name="Fig Desktop"
        UpgradeCode="39D7A6F8-807A-4531-8362-A7C1A02BDFDC"
        Version="$(var.Version)"
    >
        <Package
            Compressed="yes"
            Description="The source of truth for your team's secrets, scripts, and SSH credentials"
            Id="*"
            InstallerVersion="450"
            InstallPrivileges="limited"
            InstallScope="perUser"
            Manufacturer="Fig"
        />

        <MajorUpgrade DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit"/>

        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
        <Property Id='DiskPrompt' Value='Fig Desktop Installation'/>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="LocalAppDataFolder">
                <Directory Id="FIGROOT" Name="Fig">
                    <Component Guid="4C18EC22-F12B-47AB-ABA4-662FA0E33418" Id="InstallFigDesktop">
                        <RegistryValue
                            Key="Software\Fig\FigDesktop"
                            KeyPath="yes"
                            Name="InstallFolder"
                            Root="HKCU"
                            Type="string"
                            Value="[INSTALLFOLDER]"
                        />
                        <File
                            Name="fig_desktop.exe"
                            Source="target/release/fig_desktop.exe"
                        />
                        <RemoveFolder
                            Id="RemoveINSTALLFOLDER"
                            On="uninstall"
                        />
                        <RemoveFolder
                            Id="RemoveFIGROOT"
                            Directory="FIGROOT"
                            On="uninstall"
                        />
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <Feature Id="Install">
            <ComponentRef Id="InstallFigDesktop"/>
        </Feature>

        <CustomAction
            Id="Run"
            Impersonate="yes"
            Return="asyncNoWait"
            FileKey="fig_desktop.exe"
            ExeCommand="--dashboard"
        />

        <InstallExecuteSequence>
            <Custom Action="Run" After="InstallFinalize">NOT Installed AND NOT PATCH</Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>
